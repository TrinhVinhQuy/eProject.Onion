@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <style>
        .title-cart {
            font-size: 15px;
            text-transform: uppercase;
            color: #000;
            font-weight: 700;
            border: none;
            padding-left: 0px;
            padding-bottom: 20px;
        }

        .amount_mobie {
            display: inline-block;
            width: 180px; /* Độ rộng tối đa mà bạn muốn hiển thị */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 15px;
        }

            .amount_mobie span {
                color: black;
            }
    </style>

}
<main>
    <!-- breadcrumb area start -->
    <section class="breadcrumb-area pt-140 pb-140 bg_img" data-overlay="dark" data-opacity="5" data-background="../assets/images/bg/testimonial-bg-2.jpg">
        <div class="shape shape__1"><img src="~/assets/images/shape/breadcrumb-shape-1.png" alt=""></div>
        <div class="shape shape__2"><img src="~/assets/images/shape/breadcrumb-shape-2.png" alt=""></div>
        <div class="container">
            <div class="row">
                <div class="col-xl-12 text-center">
                    <h2 class="page-title">Giỏ hàng</h2>
                    <div class="cafena-breadcrumb breadcrumbs">
                        <ul class="list-unstyled d-flex align-items-center justify-content-center">
                            <li class="cafenabcrumb-item duxinbcrumb-begin">
                                <a asp-controller="Home" asp-action="Index"><span>Trang chủ</span></a>
                            </li>
                            <li class="cafenabcrumb-item duxinbcrumb-end">
                                <span>Giỏ hàng</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<div class="cart-area pt-60 pb-60">
    <div class="container">
        <div class="row">
            <div class="col-xl-12">
                <div class="cart-wrapper">
                    <div class="table-content table-responsive">
                        <div class="d-none d-sm-block" id="cartTable">
                        </div>
                        <!--view mobie-->
                        <div class="d-sm-none" id="cartTableMobie">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-6 col-lg-6">
                <div class="mt-30 d-grid" style="justify-items:center">
                    <p class="title-cart text-center">Thông tin giao hàng</p>
                    <div style="width: 100%">
                        <label class="form-label">Tỉnh / Thành phố</label>
                        <select class="form-control" id="province">
                            <option value="">Chọn tỉnh thành</option>
                        </select>
                        <input type="text" name="province" class="d-none" value="@ViewBag.Province" />
                    </div>
                    <div style="width: 100%">
                        <label class="form-label">Quận / Huyện</label>
                        <select class="form-control" id="district">
                            <option value="">Chọn quận/huyện</option>
                        </select>
                        <input type="text" name="district" class="d-none" value="@ViewBag.District" />
                    </div>
                    <div style="width: 100%">
                        <label class="form-label">Phường / Xã</label>
                        <select class="form-control" id="town">
                            <option value="">Chọn phường/xã</option>
                        </select>
                        <input type="text" name="town" class="d-none" value="@ViewBag.Town" />
                    </div>
                    <div style="width: 100%">
                        <label class="form-label">Địa chỉ/ Số nhà</label>
                        <input class="form-control" id="Address" placeholder="Nhập địa chỉ/ số nhà" value="@ViewBag.Address" />
                    </div>
                </div>
            </div>
            <div class="col-xl-6 col-lg-6 justify-content-end">
                <div class="cart-total mt-30">
                    <p class="title-cart text-center">Thành tiền</p>
                    <div class="ct-sub ct-sub__total">
                        <span>Thành tiền</span>
                        <span id="txtTotal">0 đ</span>
                    </div>
                    <div class="d-grid" style="padding-left: 30px; min-width:300px; width: 70%">
                        <p class="title-cart text-center">Hình thức thanh toán</p>
                        <div class="d-flex border-bottom">
                            <input type="radio" name="Pay" id="Cod" style="margin-right: 20px" value="" checked />
                            <label for="Cod">Thanh toán Cod</label>
                        </div>
                        <div class="d-flex border-bottom">
                            <input type="radio" name="Pay" id="VnPay" style="margin-right: 20px" value="" />
                            <label for="VnPay">Thanh toán VnPay</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        function formatCurrency(value) {
            return parseInt(value).toLocaleString('vi-VN') + " đ";
        }

        function updateCartTable(data) {
            var cartTableHTML = '<table class="table"><thead><tr><th class="product-thumbnail">Hình ảnh</th><th class="cart-product-name">Tên</th><th class="product-price">Đơn giá</th><th class="product-quantity">Số lượng</th><th class="product-subtotal">Tổng</th></tr></thead><tbody>';
            var cartTableHTMLmobie = '<table class="table" style="width: 100%;"><thead><tr><th class="product-thumbnail ">Sản phẩm</th></tr></thead><tbody>';

            if (data.results && data.results.length > 0) {
                data.results.forEach(function (item) {
                    cartTableHTML += '<tr>';
                    cartTableHTML += '<td class="product-thumbnail"><a href="#" class="img"><img src="' + item.metaImage + '" alt=""></a>';
                    cartTableHTML += '<a href="javascript:void(0)" class="product-remove" onclick="addToCartNoModal(' + item.id + ',' + '1' + ')"><i class="fal fa-plus"></i></a>';
                    cartTableHTML += '<a href="javascript:void(0)" class="product-remove" onclick="addToCartNoModal(' + item.id + ',' + '-1' + ')" ><i class="fal fa-minus"></i></a>';
                    cartTableHTML += '<a href="javascript:void(0)" class="product-remove" onclick="deleteFromCartNoModal(' + item.id + ')"><i class="fal fa-times"></i></a></td>';
                    cartTableHTML += '<td class="product-name"><a href="#">' + item.name + '</a></td>';
                    cartTableHTML += '<td class="product-price"><span class="amount">' + formatCurrency(item.price) + '</span></td>';
                    cartTableHTML += '<td class="product-quantity"><input type="number" value="' + item.quantity + '" min="1"></td>';
                    cartTableHTML += '<td class="product-subtotal"><span class="amount">' + formatCurrency(item.price * item.quantity) + '</span></td>';
                    cartTableHTML += '</tr>';

                    cartTableHTMLmobie += '<tr class="d-sm-none">';
                    cartTableHTMLmobie += '<td class="product-thumbnail">';
                    cartTableHTMLmobie += '<a href="#" class="img"><img src="' + item.metaImage + '" alt=""></a>';
                    cartTableHTMLmobie += '<div>';
                    cartTableHTMLmobie += '<div class="product-remove"><span class="amount amount_mobie">' + item.name + '</span></div>';
                    cartTableHTMLmobie += '<a href="javascript:void(0)" class="product-remove" onclick="addToCartNoModal(' + item.id + ',' + '1' + ')"><i class="fal fa-plus"></i></a>';
                    cartTableHTMLmobie += '<span class="product-remove" style="color: #000;">' + item.quantity + '</span>';
                    cartTableHTMLmobie += '<a href="javascript:void(0)" class="product-remove" onclick="addToCartNoModal(' + item.id + ',' + '-1' + ')"><i class="fal fa-minus"></i></a>';
                    cartTableHTMLmobie += '<a href="javascript:void(0)" class="product-remove" onclick="deleteFromCartNoModal(' + item.id + ')"><i class="fal fa-times"></i></a>';
                    cartTableHTMLmobie += '<div class="product-remove"><span class="amount amount_mobie d-flex justify-content-between"><span>Đơn giá</span><span>' + formatCurrency(item.price) + '</span></span></div>';
                    cartTableHTMLmobie += '<div class="product-remove"><span class="amount amount_mobie d-flex justify-content-between"><span>Tổng</span><span>' + formatCurrency(item.price * item.quantity) + '</span></span></div>';
                    cartTableHTMLmobie += '</div>';
                    cartTableHTMLmobie += '</td>';
                    cartTableHTMLmobie += '</tr>';
                });
            } else {
                cartTableHTML += '<tr><td colspan="5">Giỏ của bạn đang trống!</td></tr>';
                cartTableHTMLmobie += '<tr><td colspan="5">Giỏ của bạn đang trống!</td></tr>';
                $('#PayCart').hide();
            }
            cartTableHTML += '</tbody></table>';
            $('#cartTable').html(cartTableHTML);
            $('#cartTableMobie').html(cartTableHTMLmobie);
            if (data.success) {
                $('#txtTotal').html(parseInt(data.total).toLocaleString('vi-VN') + " đ");
            } else {
                $('#txtTotal').html("0 đ");
            }
        }
        // Hàm cập nhật thông tin giỏ hàng
        function getCart() {
            $.ajax({
                url: '/json/cart',
                type: 'GET',
                success: function (data) {
                    updateCartTable(data); // Cập nhật bảng giỏ hàng
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error('Error: ' + errorThrown);
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            getCart(); // Gọi hàm getCart() khi trang web được tải lần đầu tiên
        });
    </script>
    <script>
        function addToCartNoModal(itemId, quantity) {
            console.log(itemId, quantity)
            $.ajax({
                type: "POST",
                url: "/Cart/AddCart",
                data: {
                    Id: itemId,
                    Quantity: quantity
                },
                success: function (response) {
                    if (!response.success) {
                        // Có lỗi xảy ra khi thêm mục vào giỏ hàng
                        showAlertModal('danger', response.message);
                    }
                    getCart();
                },
            });
        }

        function deleteFromCartNoModal(itemId) {
            $.ajax({
                type: "POST",
                url: "/Cart/DeleteCart",
                data: { Id: itemId },
                success: function (response) {
                    if (response.success) {
                        getCart();
                    } else {
                        // Có lỗi xảy ra khi xóa mục khỏi giỏ hàng
                        showAlertModal('danger', "Có lỗi xảy ra khi xóa mục khỏi giỏ hàng.");
                    }
                },
                error: function () {
                    // Xử lý lỗi
                    console.log("Có lỗi xảy ra khi thực hiện yêu cầu!");
                }
            });
        }
    </script>
}